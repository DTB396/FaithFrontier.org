name: (REMOVED)

on:
  push:
    paths:
      # ...existing code...
  workflow_dispatch:
    inputs:
      force_reanalysis:
        # ...existing code...
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Check API Key Availability
        id: check-key
        run: |
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "::warning::OPENAI_API_KEY secret is not set. Analysis will be skipped."
            echo "::notice::To enable AI analysis, add OPENAI_API_KEY to repository secrets"
            echo "::notice::See _docs/ANALYSIS-SYSTEM.md for setup instructions"
            echo "has_key=false" >> $GITHUB_OUTPUT
          else
            echo "::notice::OpenAI API Key is configured - running analysis"
            echo "has_key=true" >> $GITHUB_OUTPUT
          fi
        
      # ...existing code...
        
      - name: Check for changes
        if: steps.check-key.outputs.has_key == 'true'
        id: check-changes
        run: |
          git diff --quiet _data/analysis/ || echo "has_changes=true" >> $GITHUB_OUTPUT
          if [ -z "$(git status --porcelain _data/analysis/)" ]; then
            echo "::notice::No analysis changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "::notice::Analysis generated new or updated files"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
        
      # ...existing code...
          
      - name: Summary
        if: always()
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-key.outputs.has_key }}" == "true" ]; then
            echo "✅ OpenAI API Key: Configured" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.analysis.outputs.analysis_success }}" == "true" ]; then
              echo "✅ Analysis: Completed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "⚠️ Analysis: Completed with warnings" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
              echo "✅ Changes: Generated and committed" >> $GITHUB_STEP_SUMMARY
            else
              echo "ℹ️ Changes: No new analysis generated" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⏭️ OpenAI API Key: Not configured (analysis skipped)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### To Enable AI Analysis:" >> $GITHUB_STEP_SUMMARY
            echo "1. Get an OpenAI API key from https://platform.openai.com/api-keys" >> $GITHUB_STEP_SUMMARY
            echo "2. Add it to GitHub: Settings → Secrets → Actions → New secret" >> $GITHUB_STEP_SUMMARY
            echo "3. Name: \`OPENAI_API_KEY\`" >> $GITHUB_STEP_SUMMARY
            echo "4. See [_docs/ANALYSIS-SYSTEM.md](/_docs/ANALYSIS-SYSTEM.md) for details" >> $GITHUB_STEP_SUMMARY
          fi
